<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.amis.dao.FromListDao" >

    <resultMap id="selectList" type="com.amis.entity.dto.ReturnTotalList">
        <result column="tt_id" property="tt_id"/>
        <result column="start_time" property="start_time"/>
        <result column="end_time" property="end_time"/>
        <result column="train_duration" property="train_duration"/>
        <result column="tc_name" property="tc_name"/>
        <result column="total_one" property="total_one"/>
        <result column="total_two" property="total_two"/>
        <result column="total_three" property="total_three"/>
        <result column="total_four" property="total_four"/>
    </resultMap>
    <select id="selectFromList" resultMap="selectList">
       SELECT ttt.tt_id,ttt.start_time,ttt.end_time,ttt.train_duration,tc.tc_name,SUM(tr.action_actual_one) AS total_one,SUM(tr.action_actual_two) AS total_two,SUM(tr.action_actual_three) AS total_three,SUM(tr.action_actual_four) as total_four
        FROM tab_total_train ttt LEFT JOIN tab_class tc on ttt.tc_id = tc.tc_id
        LEFT JOIN tab_result tr ON tr.tt_id = ttt.tt_id
        WHERE ttt.u_id = #{u_id} AND ttt.hide = 0 GROUP BY ttt.start_time DESC
    </select>

    <select id="selectTotalTab" resultType="com.amis.entity.dto.ClassTrainTabDTO">
        SELECT ttt.tt_id,COUNT(tr.tr_id)as join_number,ttt.action_set_one,ttt.action_set_two,ttt.action_set_three,ttt.action_set_four,
        TIMESTAMPDIFF(MINUTE, ttt.start_time, ttt.end_time) as time_difference,
        COUNT(IF(ttt.action_set_one &lt; tr.action_actual_one,true,null)
        AND IF(ttt.action_set_two &lt; tr.action_actual_two,true,null)
        AND IF(ttt.action_set_three &lt; tr.action_actual_three,true,null)
        AND IF(ttt.action_set_four &lt; tr.action_actual_four,true,null))as actual_number,
        ROUND( COUNT(IF(ttt.action_set_one &lt; tr.action_actual_one,true,null)
        AND IF(ttt.action_set_two &lt; tr.action_actual_two,true,null)
        AND IF(ttt.action_set_three &lt; tr.action_actual_three,true,null)
        AND IF(ttt.action_set_four &lt; tr.action_actual_four,true,null))/COUNT(tr.tr_id)*100,0) as total_completion_rate,
        ROUND(IF(ttt.action_set_one > 0,sum(IF(ttt.action_set_one &lt; tr.action_actual_one,1,0)),0)/COUNT(tr.tr_id)*100,0)as one_completion_rate,
        ROUND(IF(ttt.action_set_two > 0,sum(IF(ttt.action_set_two &lt; tr.action_actual_two,1,0)),0)/COUNT(tr.tr_id)*100,0)as two_completion_rate,
        ROUND(IF(ttt.action_set_three > 0,sum(IF(ttt.action_set_three &lt; tr.action_actual_three,1,0)),0)/COUNT(tr.tr_id)*100,0)as three_completion_rate,
        ROUND(IF(ttt.action_set_four > 0,sum(IF(ttt.action_set_four &lt; tr.action_actual_four,1,0)),0)/COUNT(tr.tr_id)*100,0)as four_completion_rate
        FROM tab_total_train ttt LEFT JOIN tab_result tr ON ttt.tt_id=tr.tt_id
        where ttt.tt_id = #{tt_id}
    </select>

    <resultMap id="selectStudentLists" type="com.amis.entity.dto.StudentTrainList">
        <result column="tr_id" property="tr_id"/>
        <result column="uc_name" property="uc_name"/>
        <result column="tc_name" property="tc_name"/>
        <result column="action_actual_one" property="action_actual_one"/>
        <result column="action_actual_two" property="action_actual_two"/>
        <result column="action_actual_three" property="action_actual_three"/>
        <result column="action_actual_four" property="action_actual_four"/>
    </resultMap>

    <select id="selectStudentList" resultMap="selectStudentLists">
        SELECT tr.tr_id,tus.uc_name,tr.action_actual_one,tr.action_actual_two,tr.action_actual_three,tr.action_actual_four
	 FROM tab_result tr LEFT JOIN tab_uc_student tus ON tr.uc_id = tus.uc_id WHERE tr.tt_id = #{tt_id};
    </select>

    <select id="selectStudentTab" resultType="com.amis.entity.dto.StudentTrainTab">
        SELECT
IF(ROUND(tr.action_actual_one/ttt.action_set_one*100,0)>100,100,ROUND(tr.action_actual_one/ttt.action_set_one*100,0))as one_completion_rate,
IF(ROUND(tr.action_actual_two/ttt.action_set_two*100,0)>100,100,ROUND(tr.action_actual_two/ttt.action_set_two*100,0))as two_completion_rate,
IF(ROUND(tr.action_actual_three/ttt.action_set_three*100,0)>100,100,ROUND(tr.action_actual_three/ttt.action_set_three*100,0))as three_completion_rate,
IF(ROUND(tr.action_actual_four/ttt.action_set_four*100,0)>100,100,ROUND(tr.action_actual_four/ttt.action_set_four*100,0))as four_completion_rate,
tr.action_one_speed,tr.action_one_frequency,tr.action_one_fluency,tr.action_one_melody,tr.action_one_power,
tr.action_two_speed,tr.action_two_frequency,tr.action_two_fluency,tr.action_two_melody,tr.action_two_power,
tr.action_three_speed,tr.action_three_frequency,tr.action_three_fluency,tr.action_three_melody,tr.action_three_power,
tr.action_four_speed,tr.action_four_frequency,tr.action_four_fluency,tr.action_four_melody,tr.action_four_power
from tab_result tr LEFT JOIN tab_total_train ttt ON tr.tt_id = ttt.tt_id
WHERE tr.tr_id = #{tr_id}
    </select>


    <resultMap id="queryClassReportList" type="com.amis.entity.dto.QueryClassReportDTO">
        <result column="tc_name" property="tc_name"/>
        <result column="u_id" property="u_id"/>
        <result column="start_time" property="start_time"/>
        <result column="end_time" property="end_time"/>
    </resultMap>

    <select id="queryClassReport">
        select * from tab_total_train where tc_id = #{tc_id} and u_id = #{u_id} and start_time between #{start_time} and #{end_time}
    </select>

</mapper>