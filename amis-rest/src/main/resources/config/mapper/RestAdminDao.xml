<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.amis.dao.RestAdminDao" >

    <resultMap id="selectEditions" type="com.amis.entity.Edition">
        <result column="tet_id" property="tet_id"/>
        <result column="versionCode" property="versionCode"/>
        <result column="isUpdate" property="isUpdate"/>
        <result column="message" property="message"/>
        <result column="fileUrl" property="fileUrl"/>
        <result column="isHotUpdate" property="isHotUpdate"/>
        <result column="hotCode" property="hotCode"/>
        <result column="editionReleasePeople" property="editionReleasePeople"/>
    </resultMap>

    <select id="selectEditionList" resultMap="selectEditions">
        select tet_id,versionCode,isUpdate,message,fileUrl,isHotUpdate,hotCode,editionReleasePeople from tab_edition
    </select>


    <delete id="deleteEdition">
        delete from tab_edition
        where tet_id=#{tet_id}
    </delete>

    <update id="updateEdition">
        UPDATE tab_edition
        <set>
            <if test="versionCode != null and versionCode != ''">
                versionCode = #{versionCode},
            </if>
            <if test="isUpdate != 0 ">
                isUpdate = #{isUpdate},
            </if>
            <if test="message != null and message != ''">
                message = #{message},
            </if>
            <if test="fileUrl != null and fileUrl != ''">
                fileUrl = #{fileUrl},
            </if>
            <if test="isHotUpdate != 0 ">
                isHotUpdate = #{isHotUpdate},
            </if>
            <if test="hotCode != null and hotCode != ''">
                hotCode = #{hotCode},
            </if>
            <if test="editionReleasePeople != null and editionReleasePeople != ''">
                editionReleasePeople = #{editionReleasePeople}
            </if>
        </set>
        <where>
            tet_id = #{tet_id}
        </where>
    </update>

    <select id="adminlogin" resultType="com.amis.entity.dto.AdminDTO">
        SELECT
              user_id,
              user_name,
              user_phone,
              user_role
            FROM tab_admin
            WHERE user_phone = #{user_phone} AND user_password = #{user_password}
    </select>

    <resultMap id="selectSchoolLists" type="com.amis.entity.School">
        <result column="s_id" property="s_id"/>
        <result column="s_name" property="s_name"/>
        <result column="s_province" property="s_province"/>
        <result column="s_city" property="s_city"/>
        <result column="s_ip" property="s_ip"/>
    </resultMap>

    <select id="selectSchoolList" resultMap="selectSchoolLists">
        select s_id,s_name,s_province,s_city,s_ip from tab_school
    </select>

    <insert id="addSchool">
        insert into tab_school(s_name,s_province,s_city) value (#{s_name},#{s_province},#{s_city})
    </insert>

    <delete id="deleteSchool">
        delete from tab_school
        where s_id=#{s_id}
    </delete>

    <update id="updateSchool">
        UPDATE tab_school
        <set>
            <if test="s_name != null and s_name != ''">
                s_name = #{s_name},
            </if>
            <if test="s_province != null and s_province != ''">
                s_province = #{s_province},
            </if>
            <if test="s_city != null and s_city != ''">
                s_city = #{s_city}
            </if>
        </set>
        <where>
            s_id = 1
        </where>
    </update>



    <resultMap id="selectCoach" type="com.amis.entity.dto.ReturnCoachDTO">
        <result column="u_id" property="u_id"/>
        <result column="u_name" property="u_name"/>
        <result column="u_gender" property="u_gender"/>
        <result column="u_phone" property="u_phone"/>
        <result column="coach_teaching_age" property="coach_teaching_age"/>
        <result column="coach_title" property="coach_title"/>
        <result column="s_name" property="s_name"/>
    </resultMap>

    <select id="selectCoachlList" resultMap="selectCoach">
        select tu.u_id,tu.u_name,tu.u_gender,tu.u_phone,tu.coach_teaching_age,tu.coach_title,ts.s_name from tab_user tu left join tab_school ts on tu.s_id = ts.s_id
    </select>


    <insert id="addCoach" parameterType="com.amis.entity.Users" useGeneratedKeys="true" keyProperty="u_id">
        insert into  tab_user(
          u_name,
          u_gender,
          u_phone,
          u_password,
          coach_teaching_age,
          u_role
          )
        values (
          #{u_name},
          #{u_gender},
          #{u_phone},
          #{u_password},
          #{coach_teaching_age},
          1)
    </insert>


    <insert id="addCoachClass" >
        insert into  tab_class_teaching(
          u_id,
          tc_id
          )
        values (
          #{u_id},
          #{tc_id})
    </insert>

    <delete id="deleteCoach">
        delete from tab_user
        where u_id=#{u_id}
    </delete>


    <resultMap id="selectStudent" type="com.amis.entity.dto.ReturnStudentListDTO">
        <result column="uc_id" property="uc_id"/>
        <result column="uc_name" property="uc_name"/>
        <result column="uc_phone" property="uc_phone"/>
        <result column="eq_mac" property="eq_mac"/>
        <result column="tc_name" property="tc_name"/>
        <result column="tc_id" property="tc_id"/>
    </resultMap>

    <select id="selectStudentList" resultMap="selectStudent">
        select uc.uc_id,uc.uc_name,uc.uc_phone,uc.eq_mac,tc.tc_name,uc.tc_id from tab_uc_student uc left join tab_class tc on uc.tc_id = tc.tc_id
    </select>



    <insert id="addStudent">
        insert into  tab_uc_student(
          uc_name,
          uc_gender,
          uc_phone,
          uc_password,
          u_role,
          eq_mac,
          tc_id)
        values (
          #{uc_name},
          #{uc_gender},
          #{uc_phone},
          #{uc_password},
          1,
          #{eq_mac},
          #{tc_id})
    </insert>

    <delete id="deleteStudent">
        delete from tab_uc_student
        where uc_id=#{uc_id}
    </delete>



    <resultMap id="selectEquipment" type="com.amis.entity.dto.EquipmentDTO">
        <result column="te_id" property="te_id"/>
        <result column="te_mac" property="te_mac"/>
        <result column="te_edition" property="te_edition"/>
        <result column="uc_name" property="uc_name"/>
    </resultMap>

    <select id="selectEquipmentList" resultMap="selectEquipment">
         select te.te_id,te.te_mac,te.te_edition,tus.uc_name from tab_equipment te left join tab_uc_student tus on te.uc_id = tus.uc_id
    </select>



    <insert id="addEquipment">
        insert into  tab_equipment(
          te_mac,
          te_edition,
          uc_id)
        values (
          #{te_mac},
          #{te_edition},
          #{uc_id})
    </insert>

    <delete id="deleteEquipment">
        delete from tab_equipment
        where te_id=#{te_id}
    </delete>




    <resultMap id="selectFeedbacksList" type="com.amis.entity.dto.FeedbackDTO">
        <result column="tf_id" property="tf_id"/>
        <result column="tf_content" property="tf_content"/>
        <result column="tf_time" property="tf_time"/>
        <result column="u_name" property="u_name"/>
    </resultMap>

    <select id="selectFeedback" resultMap="selectFeedbacksList">
         SELECT tf.tf_id,tf.tf_content,DATE_FORMAT(tf.tf_time,'%Y-%m-%e %h:%i:%s') as tf_time,tu.u_name from tab_feedback tf LEFT JOIN tab_user tu on tf.u_id = tu.u_id
    </select>

    <resultMap id="selectClassList" type="com.amis.entity.dto.AdminClass">
        <result column="tc_id" property="tc_id"/>
        <result column="tc_name" property="tc_name"/>
        <result column="tc_number" property="tc_number"/>
        <result column="u_name" property="u_name"/>
    </resultMap>

    <select id="selectClass" resultMap="selectClassList">
SELECT tc.tc_id,tc.tc_name,COUNT(tus.uc_id) as tc_number,tu.u_name
from tab_class tc
LEFT JOIN tab_uc_student tus ON tc.tc_id = tus.tc_id
LEFT JOIN tab_class_teaching tct ON tc.tc_id = tct.tc_id
LEFT JOIN tab_user tu ON tct.u_id = tu.u_id
 GROUP BY tc.tc_id
    </select>

    <select id="selectClassCoach" resultType="com.amis.entity.dto.ReturnCoachDTO">
       select tu.u_id,tu.u_name,tu.u_gender,tu.u_phone,tu.coach_teaching_age,tu.coach_title,ts.s_name
        from tab_class_teaching tct LEFT JOIN tab_user tu ON tct.u_id = tu.u_id
        LEFT JOIN tab_school ts ON tu.s_id = ts.s_id
        WHERE tct.tc_id = #{tc_id}
    </select>


    <resultMap id="selectClassStudentList" type="com.amis.entity.dto.ReturnStudentListDTO">
        <result column="uc_id" property="uc_id"/>
        <result column="uc_name" property="uc_name"/>
        <result column="uc_phone" property="uc_phone"/>
        <result column="eq_mac" property="eq_mac"/>
        <result column="tc_name" property="tc_name"/>
    </resultMap>

    <select id="selectClassStudent" resultMap="selectClassStudentList">
SELECT tus.uc_id,tus.uc_name,tus.uc_phone,tus.eq_mac,tc.tc_name from tab_uc_student tus LEFT JOIN tab_class tc ON tus.tc_id = tc.tc_id
WHERE tus.tc_id = #{tc_id}
    </select>

    <insert id="addClass">
        insert into  tab_class(
          tc_name)
        values (
          #{tc_name}
          )
    </insert>

    <delete id="deleteClass">
        delete from tab_class
        where tc_id=#{tc_id}
    </delete>

    <resultMap id="getSchoolIPList" type="com.amis.entity.School">
        <result column="s_name" property="s_name"/>
        <result column="s_province" property="s_province"/>
        <result column="s_city" property="s_city"/>
        <result column="s_ip" property="s_ip"/>
    </resultMap>

    <select id="getSchoolIP" resultMap="getSchoolIPList">
        select s_name,s_province,s_city,s_ip from tab_school
    </select>


    <insert id="addAdmin">
        insert into  tab_admin(
          user_name,
          user_phone,
          user_password,
          user_role)
        values (
          #{user_name},
          #{user_phone},
          #{user_password},
          #{user_role})
    </insert>


    <select id="updatestudent" resultType="com.amis.entity.dto.UpdateStudent">
        select tus.uc_id,tus.uc_name,tus.uc_phone,tus.eq_mac,tus.tc_id,tc.tc_name from tab_uc_student tus
        left join tab_class tc on tus.tc_id = tc.tc_id where tus.uc_id = #{uc_id}
    </select>


    <update id="updateUser">
        UPDATE tab_user
        <set>
            <if test="u_name != null and u_name != ''">
                u_name = #{u_name},
            </if>
            <if test="u_gender != null and u_gender != ''">
                u_gender = #{u_gender},
            </if>
            <if test="coach_teaching_age != null and coach_teaching_age != ''">
                coach_teaching_age = #{coach_teaching_age},
            </if>
            <if test="u_autograph != null and u_autograph != ''">
                u_autograph = #{u_autograph},
            </if>
            <if test="coach_title != null and coach_title != ''">
                coach_title = #{coach_title}
            </if>
        </set>
        <where>
            u_id = #{u_id}
        </where>
    </update>


    <select id="selectStudentPage" resultType="String">
        SELECT COUNT(uc_id) AS studentPage FROM tab_uc_student
    </select>

    <select id="selectTrainPage" resultType="String">
        SELECT COUNT(u_id) AS trainPage FROM tab_user
    </select>

    <select id="selectClassPage" resultType="String">
        SELECT COUNT(tc_id) AS classPage FROM tab_class
    </select>


    <select id="selectPageStatistics" resultType="com.amis.entity.dto.PageStatisticsDTO">
        SELECT COUNT(ttt.tt_id) AS trainTotal, SUM(TIMESTAMPDIFF(MINUTE,ttt.start_time,ttt.end_time))AS totalTrainMinute,
        (SELECT ROUND( COUNT(IF(ttt.action_set_one &lt;= tr.action_actual_one,true,null)
        AND IF(ttt.action_set_two &lt;= tr.action_actual_two,true,null)
        AND IF(ttt.action_set_three &lt;= tr.action_actual_three,true,null)
        AND IF(ttt.action_set_four &lt;= tr.action_actual_four,true,null))/COUNT(tr.tr_id)*100,2) as total_completion_rate
        FROM ${tab_result} tr LEFT JOIN ${tab_total_train} ttt ON ttt.tt_id=tr.tt_id WHERE ttt.train_state = 2 AND
        ttt.insert_time BETWEEN #{start_time} AND #{end_time}) AS totalCompletionRrate
        FROM ${tab_total_train} ttt WHERE ttt.train_state = 2 AND
        ttt.insert_time BETWEEN #{start_time} AND #{end_time}
    </select>


    <select id="selectWeekCompletionRrate" resultType="String">
        SELECT ROUND(AVG(ROUND((IF(ttt.action_set_one = 0,0,IF(ROUND(tr.action_actual_one / ttt.action_set_one * 100,0) > 100,100,ROUND(tr.action_actual_one / ttt.action_set_one * 100,0)))
+ IF(ttt.action_set_two = 0,0,IF(ROUND(tr.action_actual_two / ttt.action_set_two * 100,0) > 100,100,ROUND(tr.action_actual_two / ttt.action_set_two * 100,0)))
+ IF(ttt.action_set_three = 0,0,IF(ROUND(tr.action_actual_three / ttt.action_set_three * 100,0) > 100,100,ROUND(tr.action_actual_three / ttt.action_set_three * 100,0)))
+ IF(ttt.action_set_four = 0,0,IF(ROUND(tr.action_actual_four / ttt.action_set_four * 100,0) > 100,100,ROUND(tr.action_actual_four / ttt.action_set_four * 100,0))))/(IF(ttt.action_set_one>0,1,0)+IF(ttt.action_set_two>0,1,0)+IF(ttt.action_set_three>0,1,0)+IF(ttt.action_set_four>0,1,0)),0)),0)as weekCompletionRrate
FROM ${tab_total_train} ttt LEFT JOIN ${tab_result} tr ON ttt.tt_id = tr.tt_id
WHERE   YEARWEEK( date_format(ttt.insert_time,'%Y-%m-%d' ) ) = YEARWEEK( now() ) AND ttt.train_state = 2
    </select>


    <update id="updatestudentVal">
        UPDATE tab_uc_student
        <set>
            <if test="uc_name != null and uc_name != ''">
                uc_name = #{uc_name},
            </if>
            <if test="uc_phone != null and uc_phone != ''">
                uc_phone = #{uc_phone},
            </if>
            <if test="eq_mac != null and eq_mac != ''">
                eq_mac = #{eq_mac},
            </if>
            <if test="tc_id != null and tc_id != ''">
                tc_id = #{tc_id}
            </if>
        </set>
        <where>
            uc_id = #{uc_id}
        </where>
    </update>

    <update id="updateCoachVal">
        UPDATE tab_user
        <set>
            <if test="u_name != null and u_name != ''">
                u_name = #{u_name},
            </if>
            <if test="u_phone != null and u_phone != ''">
                u_phone = #{u_phone},
            </if>
        </set>
        <where>
            u_id = #{u_id}
        </where>
    </update>


    <update id="updateClassVal">
        UPDATE tab_class
        <set>
            <if test="tc_name != null and tc_name != ''">
                tc_name = #{tc_name}
            </if>
        </set>
        <where>
            tc_id = #{tc_id}
        </where>
    </update>


    <resultMap id="selectgradeDTOSList" type="com.amis.entity.dto.GradeDTO">
        <result column="gr_name" property="gr_name"/>
        <result column="total_completion_rate" property="total_completion_rate"/>
    </resultMap>

    <select id="selectgradeDTOS" resultMap="selectgradeDTOSList">

        SELECT tgr.gr_name,ROUND( COUNT(IF(ttt.action_set_one &lt;= tr.action_actual_one,true,null)
        AND IF(ttt.action_set_two &lt;= tr.action_actual_two,true,null)
        AND IF(ttt.action_set_three &lt;= tr.action_actual_three,true,null)
        AND IF(ttt.action_set_four &lt;= tr.action_actual_four,true,null))/COUNT(tr.tr_id)*100,0) as total_completion_rate
        from tab_class tc LEFT JOIN tab_grade tgr ON tc.gr_id = tgr.gr_id
        LEFT JOIN ${tab_total_train} ttt ON ttt.tc_id = tc.tc_id
        LEFT JOIN ${tab_result} tr ON ttt.tt_id = tr.tt_id
        WHERE YEARWEEK( date_format(ttt.insert_time,'%Y-%m-%d' ) ) = YEARWEEK( now() ) AND ttt.train_state = 2 GROUP BY tgr.gr_id
    </select>


    <select id="selectWeekClassCompletionRrate" resultType="String">
        SELECT ROUND( COUNT(IF(ttt.action_set_one &lt;= tr.action_actual_one,true,null)
        AND IF(ttt.action_set_two &lt;= tr.action_actual_two,true,null)
        AND IF(ttt.action_set_three &lt;= tr.action_actual_three,true,null)
        AND IF(ttt.action_set_four &lt;= tr.action_actual_four,true,null))/COUNT(tr.tr_id)*100,0) as total_completion_rate
        from tab_class tc LEFT JOIN ${tab_total_train} ttt ON ttt.tc_id = tc.tc_id
        LEFT JOIN ${tab_result} tr ON ttt.tt_id = tr.tt_id
        WHERE YEARWEEK( date_format(ttt.insert_time,'%Y-%m-%d' ) ) = YEARWEEK( now() ) AND ttt.train_state = 2
    </select>

    <resultMap id="selecClassTotalDTOSList" type="com.amis.entity.dto.ClassTotalDTO">
        <result column="tc_name" property="tc_name"/>
        <result column="total_completion_rate" property="total_completion_rate"/>
    </resultMap>

    <select id="selecClassTotalDTOS" resultMap="selecClassTotalDTOSList">
        SELECT * from (
        SELECT tc.tc_name,ROUND( COUNT(IF(ttt.action_set_one &lt;= tr.action_actual_one,true,null)
        AND IF(ttt.action_set_two &lt;= tr.action_actual_two,true,null)
        AND IF(ttt.action_set_three &lt;= tr.action_actual_three,true,null)
        AND IF(ttt.action_set_four &lt;= tr.action_actual_four,true,null))/COUNT(tr.tr_id)*100,0) as total_completion_rate
        from tab_class tc LEFT JOIN ${tab_total_train} ttt ON ttt.tc_id = tc.tc_id
        LEFT JOIN ${tab_result} tr ON ttt.tt_id = tr.tt_id
        WHERE YEARWEEK( date_format(ttt.insert_time,'%Y-%m-%d' ) ) = YEARWEEK( now() ) AND ttt.train_state = 2 GROUP BY tc.tc_id)
        as ta ORDER BY ta.total_completion_rate DESC
    </select>


    <resultMap id="getStudentTrainList" type="com.amis.entity.dto.StudentTrainTotalList">
        <result column="start_time" property="start_time"/>
        <result column="end_time" property="end_time"/>
        <result column="action_one_rate" property="action_one_rate"/>
        <result column="action_two_rate" property="action_two_rate"/>
        <result column="action_three_rate" property="action_three_rate"/>
        <result column="action_four_rate" property="action_four_rate"/>
        <result column="action_total_rate" property="action_total_rate"/>
        <result column="action_set_one" property="action_set_one"/>
        <result column="action_set_two" property="action_set_two"/>
        <result column="action_set_three" property="action_set_three"/>
        <result column="action_set_four" property="action_set_four"/>
        <result column="action_actual_one" property="action_actual_one"/>
        <result column="action_actual_two" property="action_actual_two"/>
        <result column="action_actual_three" property="action_actual_three"/>
        <result column="action_actual_four" property="action_actual_four"/>
        <result column="action_one_speed" property="action_one_speed"/>
        <result column="action_one_frequency" property="action_one_frequency"/>
        <result column="action_one_melody" property="action_one_melody"/>
        <result column="action_one_fluency" property="action_one_fluency"/>
        <result column="action_one_power" property="action_one_power"/>
        <result column="action_two_speed" property="action_two_speed"/>
        <result column="action_two_frequency" property="action_two_frequency"/>
        <result column="action_two_melody" property="action_two_melody"/>
        <result column="action_two_fluency" property="action_two_fluency"/>
        <result column="action_two_power" property="action_two_power"/>
        <result column="action_three_speed" property="action_three_speed"/>
        <result column="action_three_frequency" property="action_three_frequency"/>
        <result column="action_three_melody" property="action_three_melody"/>
        <result column="action_three_fluency" property="action_three_fluency"/>
        <result column="action_three_power" property="action_three_power"/>
        <result column="action_four_speed" property="action_four_speed"/>
        <result column="action_four_frequency" property="action_four_frequency"/>
        <result column="action_four_melody" property="action_four_melody"/>
        <result column="action_four_fluency" property="action_four_fluency"/>
        <result column="action_four_power" property="action_four_power"/>
    </resultMap>

    <select id="getStudentTrain" resultMap="getStudentTrainList">
SELECT ROUND(IF(ttt.action_set_one = 0,0,IF(ROUND(tr.action_actual_one / ttt.action_set_one * 100,0) > 100,100,ROUND(tr.action_actual_one / ttt.action_set_one * 100,0))),0) as action_one_rate,
ROUND(IF(ttt.action_set_two = 0,0,IF(ROUND(tr.action_actual_two / ttt.action_set_two * 100,0) > 100,100,ROUND(tr.action_actual_two / ttt.action_set_two * 100,0))),0) as action_two_rate,
ROUND(IF(ttt.action_set_three = 0,0,IF(ROUND(tr.action_actual_three / ttt.action_set_three * 100,0) > 100,100,ROUND(tr.action_actual_three / ttt.action_set_one * 100,0))),0) as action_three_rate,
ROUND(IF(ttt.action_set_four = 0,0,IF(ROUND(tr.action_actual_four / ttt.action_set_four * 100,0) > 100,100,ROUND(tr.action_actual_four / ttt.action_set_four * 100,0))),0) as action_four_rate,
ROUND(ROUND(ROUND(IF(ttt.action_set_one = 0,0,IF(ROUND(tr.action_actual_one / ttt.action_set_one * 100,0) > 100,100,ROUND(tr.action_actual_one / ttt.action_set_one * 100,0))),0)+
ROUND(IF(ttt.action_set_two = 0,0,IF(ROUND(tr.action_actual_two / ttt.action_set_two * 100,0) > 100,100,ROUND(tr.action_actual_two / ttt.action_set_two * 100,0))),0)+
ROUND(IF(ttt.action_set_three = 0,0,IF(ROUND(tr.action_actual_three / ttt.action_set_three * 100,0) > 100,100,ROUND(tr.action_actual_three / ttt.action_set_one * 100,0))),0)+
ROUND(IF(ttt.action_set_four = 0,0,IF(ROUND(tr.action_actual_four / ttt.action_set_four * 100,0) > 100,100,ROUND(tr.action_actual_four / ttt.action_set_four * 100,0))),0))
/ROUND(IF(ttt.action_set_one > 0,1,0)+IF(ttt.action_set_two > 0,1,0)+IF(ttt.action_set_three > 0,1,0)+IF(ttt.action_set_four > 0,1,0)),0) as action_total_rate,
ttt.start_time,ttt.end_time,ttt.action_set_one,ttt.action_set_two,ttt.action_set_three,ttt.action_set_four,
tr.action_actual_one,tr.action_actual_two,tr.action_actual_three,tr.action_actual_four,
tr.action_one_speed,tr.action_one_frequency,tr.action_one_melody,tr.action_one_fluency,tr.action_one_power,
tr.action_two_speed,tr.action_two_frequency,tr.action_two_melody,tr.action_two_fluency,tr.action_two_power,
tr.action_three_speed,tr.action_three_frequency,tr.action_three_melody,tr.action_three_fluency,tr.action_three_power,
tr.action_four_speed,tr.action_four_frequency,tr.action_four_melody,tr.action_four_fluency,tr.action_four_power
FROM ${tab_result} tr LEFT JOIN ${tab_total_train} ttt ON tr.tt_id = ttt.tt_id WHERE tr.uc_id = #{uc_id} AND  ttt.insert_time BETWEEN #{start_time} AND #{end_time}
    </select>


    <resultMap id="getClassTrainExcelList" type="com.amis.entity.dto.ClassTrainExcelDTO">
        <result column="start_time" property="start_time"/>
        <result column="end_time" property="end_time"/>
        <result column="train_people_number" property="train_people_number"/>
        <result column="one_completion_rate" property="one_completion_rate"/>
        <result column="two_completion_rate" property="two_completion_rate"/>
        <result column="three_completion_rate" property="three_completion_rate"/>
        <result column="four_completion_rate" property="four_completion_rate"/>
        <result column="total_completion_rate" property="total_completion_rate"/>
    </resultMap>

    <select id="getClassTrainExcel" resultMap="getClassTrainExcelList">
        SELECT ttt.start_time,ttt.end_time,COUNT(tr.tr_id) as train_people_number,
        IF(ttt.action_set_one = 0,0,ROUND(COUNT(IF(ttt.action_set_one &lt;= tr.action_actual_one,true,null))/COUNT(tr.tr_id)*100,2))as one_completion_rate,
        IF(ttt.action_set_two = 0,0,ROUND(COUNT(IF(ttt.action_set_two &lt;= tr.action_actual_two,true,null))/COUNT(tr.tr_id)*100,2))as two_completion_rate,
        IF(ttt.action_set_three = 0,0,ROUND(COUNT(IF(ttt.action_set_three &lt;= tr.action_actual_three,true,null))/COUNT(tr.tr_id)*100,2))as three_completion_rate,
        IF(ttt.action_set_four = 0,0,ROUND(COUNT(IF(ttt.action_set_four &lt;= tr.action_actual_four,true,null))/COUNT(tr.tr_id)*100,2))as four_completion_rate,
        ROUND( COUNT(IF(ttt.action_set_one &lt;= tr.action_actual_one,true,null)
        AND IF(ttt.action_set_two &lt;= tr.action_actual_two,true,null)
        AND IF(ttt.action_set_three &lt;= tr.action_actual_three,true,null)
        AND IF(ttt.action_set_four &lt;= tr.action_actual_four,true,null))/COUNT(tr.tr_id)*100,2) as total_completion_rate
        FROM ${tab_total_train} ttt LEFT JOIN ${tab_result} tr ON ttt.tt_id = tr.tt_id
        WHERE ttt.tc_id = #{tc_id} AND  ttt.insert_time BETWEEN #{start_time} AND #{end_time} group BY ttt.tt_id

    </select>








</mapper>